version: 2

sources:
  - name: staging
    schema: LANDING
    tables:
      - name: products
        description: "Source table that stores product data."
        columns:
          - name: product_id
            tests: 
              - unique
              - not_null
          - name: price
            tests:
              - dbt_expectations.expect_column_values_to_be_between:
                  min_value: 0

      - name: warehouses
        description: "Source table that stores warehouse data."
        columns:
          - name: warehouse_id
            tests:
              - unique
              - not_null
          - name: capacity
            tests:
              - dbt_expectations.expect_column_values_to_be_between:
                  min_value: 0

      - name: suppliers
        description: "Source table that stores supplier data."
        columns:
          - name: supplier_id
            tests:
              - unique
              - not_null
          - name: contact_email
            tests:
              - dbt_expectations.expect_column_values_to_match_regex:
                  regex: '^.+@.+\..+$'

      - name: shipments
        description: "Source table that stores shipment data."
        columns:
          - name: shipment_id
            tests:
              - unique
              - not_null
          - name: supplier_id
            tests:
              - not_null
          - name: warehouse_id
            tests:
              - not_null
          - name: shipment_date
            tests:
              - not_null

      - name: shipment_items
        description: "Source table containing detailed records of items included in each shipment."
        columns:
          - name: shipment_item_id
            tests:
              - unique
              - not_null
          - name: shipment_id
            tests:
              - not_null
          - name: product_id
            tests:
              - not_null
          - name: quantity
            tests:
              - dbt_expectations.expect_column_values_to_be_between:
                  min_value: 1
              - not_null

      - name: stock
        description: "Source table containing raw stock information for each product in each warehouse."
        columns:
          - name: warehouse_id
            tests:
              - not_null
          - name: product_id
            tests:
              - not_null
          - name: quantity
            tests:
              - dbt_expectations.expect_column_values_to_be_between:
                  min_value: 0
              - not_null

      - name: sales
        description: "Source table that stores sales data."
        columns:
          - name: sale_id
            tests:
              - unique
              - not_null
          - name: sale_date
            tests:
              - not_null
          - name: product_id
            tests:
              - not_null
          - name: quantity
            tests:
              - dbt_expectations.expect_column_values_to_be_between:
                  min_value: 1
              - not_null
          - name: total_amount
            tests:
              - dbt_expectations.expect_column_values_to_be_between:
                  min_value: 0
              - not_null

      - name: orders
        description: "Source table that stores order data."
        columns:
          - name: order_id
            tests:
              - unique
              - not_null
          - name: order_date
            tests:
              - not_null

      - name: order_items
        description: "Source table containing detailed records of items in each order."
        columns:
          - name: order_item_id
            tests:
              - unique
              - not_null
          - name: order_id
            tests:
              - not_null
          - name: product_id
            tests:
              - not_null
          - name: quantity
            tests:
              - dbt_expectations.expect_column_values_to_be_between:
                  min_value: 1
              - not_null
          - name: price
            tests:
              - not_null

models:
  - name: dim_date
    description: "Dimension table containing calendar dates and related attributes (day, month, quarter, year, etc.)."
    columns:
      - name: id
        tests:
          - validate_id_date:
              column_date_target: dt
          - unique
          - not_null
      - name: year
        tests:
          - dbt_expectations.expect_column_value_lengths_to_equal:
              value: 4
      - name: month
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 1
              max_value: 12
      - name: day
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 1
              max_value: 31
      - name: quarter
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 1
              max_value: 4
      - name: month_name
        tests:
          - validate_in_set:
              value: "('january','february','march','april','may','june','july','august','september','october','november','december')"
      - name: weekday_name
        tests:
          - validate_in_set:
              value: "('sun','mon','tue','wed','thu','fri','sat')"
      - name: day_type
        tests:
          - validate_in_set:
              value: "('weekday','weekend')"
      - name: days_in_month
        description: "Jumlah hari dalam bulan"
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 28
              max_value: 31

  - name: dim_products
    description: "Dimension table that stores product information."
    columns:
      - name: product_name
        tests:
          - check_trim_lower
      - name: category
        tests:
          - validate_in_set:
              value: "('home','clothing')"

  - name: dim_suppliers
    description: "Dimension table that stores supplier information."
    columns:
      - name: supplier_id
        tests:
          - unique
          - not_null
      - name: supplier_name
        tests:
          - check_trim_lower
      - name: contact_name
        tests:
          - check_trim_lower
      - name: contact_email
        tests:
          - check_trim_lower

  - name: dim_warehouses
    description: "Dimension table that stores warehouse information."
    columns:
      - name: warehouse_id
        tests:
          - unique
          - not_null
      - name: location
        tests:
          - check_trim_lower
          - validate_in_set:
              value: "('london','manchester','birmingham','glasgow','liverpool','leeds','bristol','sheffield')"

  - name: fact_inventory
    description: "Fact table that stores daily inventory levels for each product."
    tests:
      - validate_fact_inventory_arrays
    columns:
      - name: warehouse_id
        tests:
          - relationships:
              to: ref('dim_warehouses')
              field: warehouse_id
      - name: product_id_array
        tests:
          - validate_arrays_ref_other_table:
              ref_table: ref('dim_products')
              ref_column: product_id
      - name: stock_array
        tests:
          - validate_arrays_negative
      - name: snapshotdate_id
        tests:
          - relationships:
              to: ref('dim_date')
              field: id
          - no_future_dates

  - name: fact_orders
    description: "Table containing details of customer orders, including order date, customer, and related attributes."
    columns:
      - name: orderitem_id
        tests:
          - unique
          - not_null
      - name: customer_name
        tests:
          - check_trim_lower
      - name: customer_address
        tests:
          - check_trim_lower
      - name: product_id
        tests:
          - relationships:
              to: ref('dim_products')
              field: product_id
      - name: orderdate_id
        tests:
          - relationships:
              to: ref('dim_date')
              field: id
          - no_future_dates

  - name: fact_sales
    description: "Table containing sales records, including transaction details, amounts, and related attributes."
    columns:
      - name: product_id
        tests:
          - relationships:
              to: ref('dim_products')
              field: product_id
      - name: saledate_id
        tests:
          - relationships:
              to: ref('dim_date')
              field: id
          - no_future_dates

  - name: fact_shipments
    description: "Fact table containing records of product shipments."
    columns:
      - name: shipmentitem_id
        tests:
          - unique
          - not_null
      - name: supplier_id
        tests:
          - relationships:
              to: ref('dim_suppliers')
              field: supplier_id
      - name: warehouse_id
        tests:
          - relationships:
              to: ref('dim_warehouses')
              field: warehouse_id
      - name: product_id
        tests:
          - relationships:
              to: ref('dim_products')
              field: product_id
      - name: quantity
      - name: shipmentdate_id
        tests:
          - relationships:
              to: ref('dim_date')
              field: id
          - no_future_dates
        
